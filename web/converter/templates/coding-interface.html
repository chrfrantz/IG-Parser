<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A Parser for Institutional Statements encoded in the IG Script Notation of the Institutional Grammar 2.0">
    <title>IG Parser</title>
    <link rel="icon" type="image/x-icon" href="/css/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/css/favicon.ico">
    <link rel="stylesheet" href="/css/default.css">
    <!-- ACE Editor -->
    <script src="/libraries/ace/ace.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>
<script>

    /*
    Copies content of given container to clipboard for downstream use.
     */
    function CopyToClipboard(containerid) {
        if (document.selection) {
            let range = document.body.createTextRange();
            range.moveToElementText(document.getElementById(containerid));
            range.select().createTextRange();
            document.execCommand("copy");
        } else if (window.getSelection) {
            let range = document.createRange();
            range.selectNode(document.getElementById(containerid));
            window.getSelection().addRange(range);
            let res = document.execCommand("copy");
            if (res !== true) {
                alert("Text-to-Clipboard copying failed. Please select output manually and copy via keyboard.")
            }
        }
    }

    /*
    Auto-adjusts height of target entry field based on content.
    */
    function check(target) {
        let offset = 0
        target.style.height = 'auto';
        target.style.height = target.scrollHeight + offset + 'px';
    }

</script>

<p>&nbsp;</p>
<p>&nbsp;</p>
<h1><a style="text-decoration:none" href="https://github.com/chrfrantz/IG-Parser" target="_blank">IG Parser</a></h1>
<h2>A Parser for Institutional Statements encoded in the <a href="/help/" target="_blank">IG Script Notation</a> of the <a href="https://newinstitutionalgrammar.org" target="_blank">Institutional Grammar 2.0</a></h2>
<p>&nbsp;</p>
<p>&nbsp;</p>
<div class="form">
    <form method="POST">
        <!-- Original Statement entry field -->
        <span data-text="{{.RawStmtHelp}}" class="tooltip" id="rawStmtLabel">Original Statement:</span>
        <textarea id="rawStmt" name="rawStmt" onload="check(this)" onfocusin="check(this)" onkeyup="check(this);saveFormContent()" onpaste="check(this);saveFormContent()" aria-labelledby="rawStmtLabel">{{.RawStmt}}</textarea>
        <!-- Validation error message field -->
        <div class="error" id="validateError"></div>
        <!-- Validate button -->
        <button class="button2" type="button" id="buttonValidate" switch="validate" onclick="checkRawStatementContent()">
            Validate 'Original Statement' input (checks for imbalanced parentheses)
            and copy validated content into 'Encoded Statement' field</button><br><br>
        <script>
            /*
            Validates content of 'Original Statement' field by testing for imbalanced parentheses
            and provides feedback based on error field. Copies successfully validated input
            into 'Encoded Statement' field.
             */
            function checkRawStatementContent() {

                // Button 'switch' field can have values 'overwrite' or 'validate'
                let buttonType = document.getElementById("buttonValidate").getAttribute("switch");

                if (buttonType === "overwrite") {
                    // OVERWRITE MODE

                    // Read value from raw statement
                    let rawContent = document.getElementById("rawStmt").value;
                    // Populate editor
                    let editor = ace.edit("editor");
                    editor.setValue(rawContent);
                    // Ensure that content in hidden text area is synchronized
                    copyEditorContentToTextArea();

                    // Reset button to validate mode
                    document.getElementById("buttonValidate").setAttribute("switch", "validate");
                    document.getElementById("buttonValidate").innerText =
                        "Validate 'Original Statement' input (checks for imbalanced parentheses) and " +
                        "copy validated content into 'Encoded Statement' field";
                    // Empty the error message
                    let validateError = document.getElementById("validateError");
                    validateError.innerHTML = "";

                } else if (buttonType === "validate") {
                    // VALIDATE MODE

                    // Retrieve raw content field value
                    let rawContent = document.getElementById("rawStmt").value;
                    // Count left parentheses
                    let leftParCount = (rawContent.match(/\(/g) || []).length;
                    // Count right parentheses
                    let rightParCount = (rawContent.match(/\)/g) || []).length;
                    // ... if parenthesis count differs, show error
                    if (leftParCount !== rightParCount) {
                        // Populate error message
                        let validateError = document.getElementById("validateError");
                        validateError.innerHTML = "Found imbalanced parentheses in raw input (" +
                            leftParCount + " opening and " + rightParCount + " closing parentheses).\n" +
                            "Please remove or balance parentheses to before encoding the statement.";
                    } else {
                        // Reset error message
                        let validateError = document.getElementById("validateError");
                        validateError.innerHTML = "";
                        // Copy into 'Encoded Statement' textarea ...
                        let editor = ace.edit("editor");
                        // ... but only if editor field is empty
                        if (editor.getValue().length === 0) {
                            editor.setValue(rawContent);
                            // ... and if content has not already been copied
                        } else if (editor.getValue() !== rawContent) {
                            // ... else print error
                            let validateError = document.getElementById("validateError");
                            validateError.innerHTML = "The 'Original Statement' content is valid, but has not been copied into the 'Encoded Statement' field, " +
                                "since this field already contains content (to prevent accidental overwriting of encoded statement).\<br/\>" +
                                "Confirm if you indeed want to overwrite the 'Encoded Statement' content with the 'Original Statement' content.";

                            // Switch button to overwrite mode
                            document.getElementById("buttonValidate").setAttribute("switch", "overwrite");
                            document.getElementById("buttonValidate").innerText = "Confirm overwriting of 'Encoded Statement' entry with 'Original Statement' entry";

                        } // do nothing if raw statement content is already in editor
                    }
                } // no other button switch value supported as of now
            }
        </script>
        <!-- Encoded Statement entry field -->
        <span data-text="{{.CodedStmtHelpRef}}" class="tooltip" id="editorLabel"><a href="/help/" target="_blank">Encoded Statement: (?)</a></span>
        <!-- Editor buttons -->
        <div class="buttons hidden">
            <div class="button" role="button" aria-pressed="false" tabindex="0" id="undo">Undo</div>
            <div class="button" role="button" aria-pressed="false" tabindex="0" id="redo">Redo</div>
            <span data-text="Activates nesting syntax when using button- or keybinding-based encoding (i.e., for symbols that support nesting, the corresponding braces are inserted during encoding)." class="tooltip">
            <div class="button" role="button" aria-pressed="false" tabindex="0" id="nested">Nesting</div></span>
            <span data-text="Activates semantic annotation syntax when using button- or keybinding-based encoding (i.e., semantic annotation brackets will be provided in addition to component symbol and parentheses)." class="tooltip">
            <div class="button" role="button" aria-pressed="false" tabindex="0" id="semantic">Semantic Annotation</div></span>
            <span data-text="Toggles mouse selection mode, in which encoding is performed through symbol selection, followed by text highlighting to encode the highlighted text. Useful for screen- or mouse-based input." class="tooltip">
            <div class="button" role="button" aria-pressed="false" tabindex="0" id="selection">Mouse Selection Mode</div></span>
            <span data-text="Shows a list of supported symbols and their respective IG 2.0 Components" class="tooltip">
            <div class="button" role="button" aria-pressed="false" tabindex="0" id="symbols">Show Symbols</div></span>
            <span data-text="Toggles between free-text and keybinding mode. Free-text mode allows for free text editing. Keybinding mode activates keybindings to support encoding." class="tooltip">
            <div class="button" role="button" aria-pressed="false" tabindex="0" id="lock">Free-text mode</div></span>
            <span data-text="Shows a list of supported keybindings and their respective IG 2.0 Components" class="tooltip">
            <div class="button" role="button" aria-pressed="false" tabindex="0" id="keybinds">Show Keybindings</div></span>
        </div>
        <!-- ACE Editor; copies any content to hidden textarea -->
        <div id="editor" name="editor" onkeyup="copyEditorContentToTextArea();saveFormContent()" onpaste="copyEditorContentToTextArea();saveFormContent()" aria-labelledby="editorLabel">{{.CodedStmt}}</div>
        <script>
            let editor = ace.edit("editor");
            editor.session.setMode("ace/mode/text"); // Text mode default, changed in visualToggle
            // and in loadVisual
            // Option documentation: https://github.com/ajaxorg/ace/wiki/Configuring-Ace
            editor.setOption("showLineNumbers", true); // show line numbers
            editor.setOption("wrap", true); // activate text wrapping
            editor.setOption("showGutter", true); // panel on the left
            editor.setOption("showPrintMargin", false); // 80-character margin marker
            editor.setOption("behavioursEnabled", false); // should activate automated adding of complementary brackets
            editor.setOption("cursorStyle", "ace");
            editor.setOption("fontFamily", "monospace"); // has to be monospace for correct operation
            editor.setOption("fontSize", 16); // font size
            editor.setOption("minLines", 5); // standard size
            editor.setOption("maxLines", 30); // number of lines before using scrollbar

            // Shift-tab to navigate down out of the editor
            editor.commands.addCommand({
                name: "tabNextElement",
                bindKey: { win: "Tab", mac: "Tab"},
                exec: function(editor) {
                    document.GetElementById("A").focus;
                }
            })

            // Shift-tab to navigate up out of the editor
            editor.commands.addCommand({
                name: "tabPrevElement",
                bindKey: { win: "Shift-Tab", mac: "Shift-Tab"},
                exec: function(editor) {
                    document.GetElementById("keybinds").focus;
                }
            })

            //console.log("Version: " + ace.version);

            /*
            Copies content from editor to hidden textarea (which is used for form submission)
             */
            function copyEditorContentToTextArea() {
                let ta = document.getElementById("codedStmt");
                // Populate textarea with editor content
                ta.value = editor.getValue();
            }

            // Local storage

            /*
            Stores the editor content in browser local storage.
             */
            function saveFormContent() {
                // Store encoded statement
                let content = editor.getValue();
                localStorage.setItem("codedStmt", content);
                //console.log("Storing content " + content)

                // Store raw statement
                saveValue("rawStmt");

                // Elements specific to distinctive versions;
                // require checks for presence prior to saving

                // Tabular-specific fields

                // Statement ID
                saveValue("stmtId");

                // Extended output
                saveCheckbox("igExtended");

                // Logico output (both for tabular and visual)
                saveCheckbox("annotations");

                // Include headers
                saveCheckbox("includeHeaders");

                // Tabular output format
                saveValue("outputType");

                // Original Statement inclusion
                saveValue("printOriginalStatement");

                // IG Script inclusion
                saveValue("printIgScript");

                // Visual-specific fields

                // Dov
                saveCheckbox("dov");

                // Include Property tree
                saveCheckbox("propertyTree");

                // Include Binary tree
                saveCheckbox("binaryTree");

                // Activation condition
                saveCheckbox("actCondTop");

                // Canvas height
                saveValue("canvasHeight");

                // Canvas width
                saveValue("canvasWidth");

            }

            // Editor buttons above the editor
            // Undo button for editor input
            document.getElementById("undo").addEventListener("click", function() {
                editor.undo();
            });

            // Redo button for editor input
            document.getElementById("redo").addEventListener("click", function() {
                editor.redo();
            });


            // Permissive readonly, allows redo and undo
            document.getElementById("lock").addEventListener("click", function() {
                button = document.getElementById("lock")
                //console.log(button.textContent)
                if (editor.getReadOnly()) {
                    editor.setOption("readOnly", false)
                    button.textContent = "Free-text mode"
                    button.classList.toggle('toggleActive')
                    
                    //console.log(button.textContent)
                } else {
                    editor.setOption("readOnly", "nocursor")
                    button.textContent = "Keybinding mode"
                    button.classList.toggle('toggleActive')
                    
                    //console.log(button.textContent)
                }
                
            });

            // Toggle button for visualization
            function visualToggle() {
                let visual = localStorage.getItem("visual")
                console.log(localStorage.getItem("visual"))
                let buttons = document.getElementsByClassName("buttons")
                if (visual === "false")
                    // Toggle the editor buttons' visibility
                    for (let i = 0; i < buttons.length; i++) {
                        buttons[i].classList.remove('hidden')
                        editor.session.setMode("ace/mode/igscriptnotation")
                        localStorage.setItem("visual", "true")
                    }
                else 
                    // Toggle the editor buttons' visibility
                    for (let i = 0; i < buttons.length; i++) {
                        buttons[i].classList.add('hidden')
                        editor.session.setMode("ace/mode/text");
                        localStorage.setItem("visual", "false")
                    }
            };

            // loading for visualization
            function loadVisual() {
                let visual = localStorage.getItem("visual")
                console.log(localStorage.getItem("visual"))
                let buttons = document.getElementsByClassName("buttons")
                if (visual !== "false")
                    // Toggle the editor buttons' visibility
                    for (let i = 0; i < buttons.length; i++) {
                        buttons[i].classList.remove('hidden')
                        editor.session.setMode("ace/mode/igscriptnotation")
                    }
                else 
                    // Toggle the editor buttons' visibility
                    for (let i = 0; i < buttons.length; i++) {
                        buttons[i].classList.add('hidden')
                        editor.session.setMode("ace/mode/text");
                    }  
            };

            // Toggle for nested symbols
            let nested = false
            document.getElementById("nested").addEventListener("click", function() {
                let button = document.getElementById("nested")
                button.classList.toggle('toggleActive')
                nested = !nested
            });

            // Toggle for semantic annotations for symbols
            let semanticAnnotation = false
            document.getElementById("semantic").addEventListener("click", function() {
                let button = document.getElementById("semantic")
                button.classList.toggle('toggleActive')
                semanticAnnotation = !semanticAnnotation
            });

            // Symbols modal
            document.getElementById("symbols").addEventListener("click", function() {
                document.getElementById("symbolModal").showModal();
            });

            // Keybindings modal
            document.getElementById("keybinds").addEventListener("click", function() {
                document.getElementById("keybindModal").showModal();
            });

            // Function for closing modals
            function closeModal(modalId){
                document.getElementById(modalId).close();
            }

            function linkIntercept(event) {
                event.preventDefault();
                let href = event.target.href;
                // Ask for confirmation
                if (confirm("Showing an example overwrites the current work done.\nAre you sure you want to overwrite your current work?")){
                    // Redirect if confirmed
                    window.location.href = href;
                }
            }

            // Symbols for the annotateSelection function
            var symbols = {
                "A":{"symbol": "A", "bracket":["(",")"]},
                "A,p":{"symbol": "A,p", "bracket":["(",")","{","}"], "nested": true},
                "I":{"symbol": "I", "bracket":["(",")"]},
                "D":{"symbol": "D", "bracket":["(",")"]},
                "Bdir":{"symbol": "Bdir", "bracket":["(",")","{","}"], "nested": true},
                "Bdir,p":{"symbol": "Bdir,p", "bracket":["(",")","{","}"], "nested": true},
                "Bind":{"symbol": "Bind", "bracket":["(",")","{","}"], "nested": true},
                "Bind,p":{"symbol": "Bind,p", "bracket":["(",")","{","}"], "nested": true},
                "Cac":{"symbol": "Cac", "bracket":["(",")","{","}"], "nested": true},
                "Cex":{"symbol": "Cex", "bracket":["(",")","{","}"], "nested": true},
                "O":{"symbol": "O", "bracket":["{","}"]},
                "E":{"symbol": "E", "bracket":["(",")"]},
                "E,p":{"symbol": "E,p", "bracket":["(",")","{","}"], "nested": true},
                "F":{"symbol": "F", "bracket":["(",")"]},
                "M":{"symbol": "M", "bracket":["(",")"]},
                "P":{"symbol": "P", "bracket":["(",")","{","}"], "nested": true},
                "P,p":{"symbol": "P,p", "bracket":["(",")","{","}"], "nested": true},
            }

            /*
            Adds the selected symbol surrounding the selected span or at the cursor location. 
            Takes a symbol (string) as input, corresponding with the object above.
            Used for screen-, mouse-, or keybinding-based encoding.
            */
            function annotateSelection(symbol) {
                //console.log("Annotating selection with: ", symbol);
                let selectionText = editor.getSelectedText();
                let selectionRange = editor.getSelectionRange();
                //console.log(selectionText)
                //console.log(selectionRange)
                // Move the cursor to within the new symbol
                cursorLocation = editor.selection.getCursor();

                // Separate handling for logical operators
                if (symbol == "L") {
                    editor.session.replace(new ace.Range(selectionRange.start.row, selectionRange.start.column, 
                        selectionRange.end.row, selectionRange.end.column), "["+selectionText.toUpperCase()+"]");
                    
                    // If the selection is empty move the cursor and activate the editor
                    if (selectionText == "") {
                        cursorLocation.column += 1;
                        editor.moveCursorToPosition(cursorLocation);
                        editor.clearSelection();
                        editor.focus(); // Set the editor to in-focus, allowing for keyboard input
                    }
                    return
                }

                // Build the output with a symbol and the corresponding brackets
                let outputText = symbols[symbol].symbol;
                // If the semanticAnnotation toggle is active add brackets for it
                outputText += semanticAnnotation ? "[]" : "";
                let bracketStart = 0
                if (nested && symbols[symbol]["nested"]){
                    bracketStart += 2
                }
                outputText += symbols[symbol].bracket[bracketStart];
                outputText += selectionText;

                outputText += symbols[symbol].bracket[bracketStart+1];

                // Add augmented text into editor
                editor.session.replace(new ace.Range(selectionRange.start.row, selectionRange.start.column, 
                    selectionRange.end.row, selectionRange.end.column), outputText);

                // Copy content of form to hidden text area (which is used for actual parsing)
                copyEditorContentToTextArea();
                // Save content to storage
                saveFormContent();

                // If the selection is empty move the cursor and activate the editor
                if (selectionText === ""){
                cursorLocation.column += outputText.length-1
                editor.moveCursorToPosition(cursorLocation);
                editor.clearSelection();
                editor.focus(); // Set the editor to in-focus, allowing for keyboard input
                }
            }

            /*
            Shows a tooltip on symbol hover. Shows the full name of the symbol.
            */
            // Snippet based on https://stackoverflow.com/questions/13725154/get-token-string-for-ace-editor#13753947
            var prevToken = ""
            var tooltip
            editor.on('mousemove', function(e) {
                //var position = editor.getCursorPosition();
                var position = e.getDocumentPosition();
                var token = editor.session.getTokenAt(position.row, position.column);
                if (token && token !== prevToken) {
                    if (prevToken !== "") {
                        document.body.removeChild(tooltip);
                        prevToken = ""
                    }
                    if (token.type !== 'text') {
                        prevToken = token;
                        //console.log(position.row, position.column, position)
                        // Get the position of the coordinates
                        let pos = editor.renderer.textToScreenCoordinates(position.row, position.column);
                        //console.log(pos)
                        tooltip = document.createElement('div');
                        // Replace the underscore with a space and show the token type
                        tooltip.innerHTML = token.type.replaceAll("_"," ");
                        tooltip.setAttribute("class", "text_tooltip")
                        tooltip.style.position = 'absolute';
                        tooltip.style.top = pos.pageY-25 + 'px';
                        tooltip.style.left = pos.pageX + 'px';
                        document.body.appendChild(tooltip);
                    }
                }
            });

            /*
            Highlighting mode
            */

            let selectedSymbol = "A"   
            let selectionMode = false  
            let mouseDown = false      
            // Toggle for selection mode
            document.getElementById("selection").addEventListener("click", function() {
                button = document.getElementById("selection")
                button.classList.toggle('toggleActive')
                button = document.getElementById(selectedSymbol)
                button.classList.toggle('toggleActive')
                selectionMode = !selectionMode
            });

            // For checking if the mouse is down
            editor.on("mousedown", function() {
                //console.log("Mouse is down")
                mouseDown = true
            })

            // On mouse up, if there is a selection and selection mode is on
            // annotate the selection with the selected symbol
            editor.on("mouseup", function() {
                if (mouseDown) {
                    if (selectionMode) {
                        selection = editor.getSelectedText()
                        //console.log(selection)

                        if (selection !== "") {
                            annotateSelection(selectedSymbol)
                        }
                    }
                    mouseDown = false
                }
            })

            // Middleware function for the buttons
            function symbolButtonHandler(symbol) {
                // If selection mode is active, change which symbol is selected and toggle
                // the active status of this symbol button and the previous symbol button.
                if (selectionMode) {
                    button = document.getElementById(selectedSymbol)
                    button.classList.toggle('toggleActive')
                    button = document.getElementById(symbol)
                    button.classList.toggle('toggleActive')
                    selectedSymbol = symbol
                } else {
                    // Just send the symbol on to the annotation function
                    annotateSelection(symbol)
                }
            }

            /*
            Saves value of a given field into localStorage. Takes checkbox field ID (not value field) as input.
             */
            function saveCheckbox(fieldId) {
                let tmpField = document.getElementById(fieldId);
                if(tmpField != null) {
                    localStorage.setItem(fieldId, tmpField.checked);
                    //console.log("Storing content " + tmpField.checked)
                }
            }

            /*
            Saves value of a given field into localStorage. Takes value field ID (not checkbox field) as input.
             */
            function saveValue(fieldId) {
                let tmpField = document.getElementById(fieldId);
                if(tmpField != null) {
                    localStorage.setItem(fieldId, tmpField.value);
                    //console.log("Storing content " + tmpField.value)
                }
            }

            /*
            Loads the content stored in local storage into editor
             */
            function loadFormContent() {
                // Load encoded statement if overriding of browser storage is not set
                if ({{.OverrideSavedStmts}} === false) {
                    // If value is stored ...
                    if (localStorage.getItem("codedStmt") != null) {
                        // ... populate editor content ...
                        let content = localStorage.getItem("codedStmt");
                        editor.setValue(content);
                        // ... and update underlying text area
                        copyEditorContentToTextArea();
                        //console.log("Loading content " + content)
                    }

                    // Load raw statement
                    loadValue("rawStmt")

                }
                // Tabular-specific fields

                // Load statement ID
                loadValue("stmtId");

                // Load IG Extended
                loadCheckbox("igExtended");

                // Load IG Logico (Tabular and Visual)
                loadCheckbox("annotations");

                // Load Header setting
                loadCheckbox("includeHeaders");

                // Load Tabular output format
                loadValue("outputType");

                // Load Original Statement inclusion choice
                loadValue("printOriginalStatement");

                // Load IG Script inclusion choice
                loadValue("printIgScript");

                // Visual-specific fields

                // Load Dov
                loadCheckbox("dov");

                // Load Property tree
                loadCheckbox("propertyTree");

                // Load Binary tree
                loadCheckbox("binaryTree");

                // Load Activation conditions
                loadCheckbox("actCondTop");

                // Load canvas height
                loadValue("canvasHeight");

                // Load canvas width
                loadValue("canvasWidth");

            }

            /*
            Loads field value from localStorage. Takes id of value field (i.e., not checkbox field) as input.
             */
            function loadValue(fieldId) {
                if(localStorage.getItem(fieldId) != null && document.getElementById(fieldId) != null) {
                    document.getElementById(fieldId).value = localStorage.getItem(fieldId);
                }
            }

            /*
            Loads checkbox field value from localStorage. Takes id of checkbox field (i.e., not value field) as input.
             */
            function loadCheckbox(fieldId) {
                if(localStorage.getItem(fieldId) != null && document.getElementById(fieldId) != null) {
                    let content = localStorage.getItem(fieldId);
                    if(content === "true") {
                        document.getElementById(fieldId).checked = true;
                        //console.log("Loading content " + content)
                    }
                    if(content === "false") {
                        document.getElementById(fieldId).checked = false;
                        //console.log("Loading content " + content)
                    }
                    // nothing stored - leave value unchanged
                }
            }

            /*
            Resets fields to original default content
             */
            function resetContent() {
                // Reset coded statement
                editor.setValue({{.DefaultCodedStmt}})
                // and copy back to hidden text area
                copyEditorContentToTextArea();

                // Reset raw statement
                document.getElementById("rawStmt").value = {{.DefaultRawStmt}};

                // Reset statement ID (if existing)
                if(document.getElementById("stmtId") != null) {
                    document.getElementById("stmtId").value = {{.DefaultStmtId}};
                }

                // Save Statement ID explicitly, since it does not display in visual mode and
                // may otherwise not be saved using the saveFormContent()
                localStorage.setItem("stmtId", {{.DefaultStmtId}});
                // Save reset values in local storage
                saveFormContent();
            }

            /*
            Resets canvas to original default content
             */
            function resetCanvas() {

                // Reset canvas height (if existing)
                if(document.getElementById("canvasHeight") != null) {
                    document.getElementById("canvasHeight").value = {{.DefaultHeight}};
                }

                // Reset canvas width (if existing)
                if(document.getElementById("canvasWidth") != null) {
                    document.getElementById("canvasWidth").value = {{.DefaultWidth}};
                }

                // Save reset values in local storage
                saveFormContent();
            }

            // Loads form contents from local storage upon window load and prepopulate examples
            window.onload = (event) => {
                loadFormContent();
                loadVisual();

                // Generate URLs for examples
                generateUrl("example2", "Example Statement 2 (moderately complex)",
                    "?rawStmt=When%20an%20inspection,%20review,%20or%20investigation%20of%20an%20accredited%20certifying%20agent%20by%20the%20Program%20Manager%20reveals%20any%20non-compliance%20with%20the%20Act%20or%20regulations%20in%20this%20part,%20a%20written%20notification%20of%20non-compliance%20shall%20be%20sent%20to%20the%20certifying%20agent.&codedStmt=Cac%7BWhen%20A(Program%20Manager)%20I[act=detect%20non-compliance](reveals)%20Bdir%7BA,p(accredited)%20A(certifying%20agent)%20I[act=non-compliant]([is%20not%20in%20compliance])%20with%20the%20Bdir(Act%20[OR]%20regulations%20in%20this%20part)%20Cac%7BWhen%20A(Program%20Manager)%20I[act=monitors](([inspects]%20[OR]%20[reviews])%20[OR]%20[investigates])%20Bdir,p(accredited)%20Bdir(certifying%20agent)%7D%7D%7D%20A([Program%20Manager])%20D(shall)%20I[act=sanction]([send])%20Bdir(notification)%20Bdir,p(of%20non-compliance)%20to%20the%20Bind,p(accredited)%20Bind(certifying%20agent).")
                generateUrl("example3", "Example Statement 3 (complex)",
                    "?rawStmt=Regional%20Managers,%20on%20behalf%20of%20the%20Secretary,%20may%20review,%20and%20reward%20or%20sanction,%20approved%20certified%20production%20and%20handling%20operations%20and%20accredited%20certifying%20agents%20for%20compliance%20with%20the%20Act%20or%20regulations%20in%20this%20part,%20under%20the%20condition%20that%20Operations%20were%20non-compliant%20or%20violated%20organic%20farming%20provisions%20and%20Manager%20has%20concluded%20investigation.&codedStmt=A,p(Regional)%20A[role=enforcer,type=animate](Managers),%20Cex(on%20behalf%20of%20the%20Secretary),%20D[stringency=permissive](may)%20I[act=performance](review%20[AND]%20(reward%20[XOR]%20sanction))%20Bdir,p(approved)%20Bdir1,p(certified)%20Bdir1[role=monitored,type=animate](production%20[operations])%20and%20Bdir[role=monitored,type=animate](handling%20operations)%20and%20Bdir2,p(accredited)%20Bdir2[role=monitor,type=animate](certifying%20agents)%20Cex[ctx=purpose](for%20compliance%20with%20the%20(Act%20[XOR]%20regulations%20in%20this%20part))%20under%20the%20condition%20that%20Cac%7BCac[state]%7BA[role=monitored,type=animate](Operations)%20I[act=violate](were%20non-compliant%20[OR]%20violated)%20Bdir[type=inanimate](organic%20farming%20provisions)%7D%20[AND]%20Cac[state]%7BA[role=enforcer,type=animate](Manager)%20I[act=terminate](has%20concluded)%20Bdir[type=activity](investigation)%7D%7D.");
            };

            // Retrieves the current URL path (to identify tabular vs. visual output)
            function generateUrl(exampleId, linkText, linkParameter) {
                let link = document.getElementById(exampleId);
                link.textContent = linkText;
                link.href = window.location.pathname + linkParameter;
            }

            // Keybinds for read only mode
            document.addEventListener("keydown", function(event) {
                // Enables the Enter key as an interact option for all divs with the "button" class
                if (event.key === "Enter" && event.target.classList.contains("button")) {
                    event.target.click();
                    return
                }
                if (editor.getReadOnly()) {
                    // Enable undo and redo
                    if (event.ctrlKey || event.cmdKey) {
                        if (event.key === "q") {
                            editor.undo();
                            return
                        } else if (event.key === "w") {
                            editor.redo();
                            return
                        }
                    }

                    // Handle keybinds for the edit mode, each binding matches a symbol
                    switch (event.key.toLowerCase()) {
                        case "a":
                            if (event.shiftKey) {
                                annotateSelection('A,p');
                            } else {
                                annotateSelection('A');}
                        break
                        case "d": annotateSelection('D'); break
                        case "i": annotateSelection('I'); break
                        case "b":
                            if (event.shiftKey) {
                                annotateSelection('Bdir,p');
                            } else {
                                annotateSelection('Bdir');}
                        break
                        case "n":
                            if (event.shiftKey) {
                                annotateSelection('Bind,p');
                            } else {
                                annotateSelection('Bind');}
                        break
                        case "c": annotateSelection('Cac'); break
                        case "v": annotateSelection('Cex'); break
                        case "e":
                            if (event.shiftKey) {
                                annotateSelection('E,p');
                            } else {
                                annotateSelection('E');}
                        break
                        case "m": annotateSelection('M'); break
                        case "o": annotateSelection('O'); break
                        case "l": annotateSelection('L'); break
                        case "f": annotateSelection('F'); break
                        case "p":
                            if (event.shiftKey) {
                                annotateSelection('P,p');
                            } else {
                                annotateSelection('P');}
                            break
                        case "|": break
                    }
                }
            });

        </script>

        <!-- Buttons for selecting symbols below the editor  -->
        <div class="buttons hidden">
            Regulative:
            <div class="button" role="button" aria-pressed="false" id="A"      tabindex="0" onclick="symbolButtonHandler('A')">Attribute</div>
            <div class="button" role="button" aria-pressed="false" id="A,p"    tabindex="0" onclick="symbolButtonHandler('A,p')">A. Property</div>
            <div class="button" role="button" aria-pressed="false" id="I"      tabindex="0" onclick="symbolButtonHandler('I')">Aim</div>
            <div class="button" role="button" aria-pressed="false" id="D"      tabindex="0" onclick="symbolButtonHandler('D')">Deontic</div>
            <div class="button" role="button" aria-pressed="false" id="Bdir"   tabindex="0" onclick="symbolButtonHandler('Bdir')">Direct Object</div>
            <div class="button" role="button" aria-pressed="false" id="Bdir,p" tabindex="0" onclick="symbolButtonHandler('Bdir,p')">D.O. Property</div>
            <div class="button" role="button" aria-pressed="false" id="Bind"   tabindex="0" onclick="symbolButtonHandler('Bind')">Indirect Object</div>
            <div class="button" role="button" aria-pressed="false" id="Bind,p" tabindex="0" onclick="symbolButtonHandler('Bind,p')">I.O. Property</div>
            <br>
            Constitutive:
            <div class="button" role="button" aria-pressed="false" id="E"      tabindex="0" onclick="symbolButtonHandler('E')">Constituted Entity</div>
            <div class="button" role="button" aria-pressed="false" id="E,p"    tabindex="0" onclick="symbolButtonHandler('E,p')">C.E. Property</div>
            <div class="button" role="button" aria-pressed="false" id="F"      tabindex="0" onclick="symbolButtonHandler('F')">Constitutive Function</div>
            <div class="button" role="button" aria-pressed="false" id="M"      tabindex="0" onclick="symbolButtonHandler('M')">Modal</div>
            <div class="button" role="button" aria-pressed="false" id="P"      tabindex="0" onclick="symbolButtonHandler('P')">Constituting Properties</div>
            <div class="button" role="button" aria-pressed="false" id="P,p"    tabindex="0" onclick="symbolButtonHandler('P,p')">C.P. Properties</div>
            <br>
            Other:
            <div class="button" role="button" aria-pressed="false" id="O"      tabindex="0" onclick="symbolButtonHandler('O')">Or Else</div>
            <div class="button" role="button" aria-pressed="false" id="L"      tabindex="0" onclick="symbolButtonHandler('L')">Logical Operator</div>
            <div class="button" role="button" aria-pressed="false" id="Cac"    tabindex="0" onclick="symbolButtonHandler('Cac')">Activation Condition</div>
            <div class="button" role="button" aria-pressed="false" id="Cex"    tabindex="0" onclick="symbolButtonHandler('Cex')">Execution Constraint</div>
        </div>

        <!-- Modal for showing the symbols available to use in the editor and their corresponding IG 2.0 components -->
        <dialog id="symbolModal">
            <table>
                <tr><th>IG Script Symbol</th><th>Corresponding IG 2.0 Component</th></tr>
                <tr><td><b>A</b></td><td>Attributes</td></tr>
                <tr><td><b>A,p</b></td><td>Attributes Property*</td></tr>
                <tr><td><b>D</b></td><td>Deontic</td></tr>
                <tr><td><b>I</b></td><td>Aim</td></tr>
                <tr><td><b>Bdir</b></td><td>Direct Object*</td></tr>
                <tr><td><b>Bdir,p</b></td><td>Direct Object Property*</td></tr>
                <tr><td><b>Bind</b></td><td>Indirect Object*</td></tr>
                <tr><td><b>Bind,p</b></td><td>Indirect Object Property*</td></tr>
                <tr><td><b>Cac</b></td><td>Activation Condition*</td></tr>
                <tr><td><b>Cex</b></td><td>Execution Constraint*</td></tr>
                <tr><td><b>E</b></td><td>Constituted Entity</td></tr>
                <tr><td><b>E,p</b></td><td>Constituted Entity Property</td></tr>
                <tr><td><b>M</b></td><td>Modal</td></tr>
                <tr><td><b>F</b></td><td>Constitutive Function</td></tr>
                <tr><td><b>P</b></td><td>Constituting Properties*</td></tr>
                <tr><td><b>P,p</b></td><td>Constituting Properties Properties*</td></tr>
                <tr><td><b>O</b></td><td>Or Else**</td></tr>
            </table>
            * In addition to component annotation, these components support component-level nesting, <br>
            with braces scoping the nested statements (e.g., <b>Bdir{ ... }</b>, <b>Bdir,p{ ... }</b>, etc.).<br>
            ** The Or else component only allows component-level nesting (i.e., substitution by an entire statement).<br>
            <div class="button" role="button" aria-pressed="false" tabindex="0" id="symbolModalClose" style="float:right" autofocus onclick="closeModal('symbolModal')">Close</div>
        </dialog>

        <!-- Modal for showing keybindings available in the editor, opens from a button on the page -->
        <dialog id="keybindModal">
            The following table shows the keys associated with particular IG 2.0 component symbols if 'Keybinding mode' is activated.<br>
            Keybindings are deactivated in 'Free-text mode' (i.e., manual annotation mode).<br>
            <table>
                <tr><th>Keybinding</th><th>IG 2.0 Component</th></tr>
                <tr><td><b>a</b></td><td>Attributes</td></tr>
                <tr><td><b>Shift-a</b></td><td>Attributes Property</td></tr>
                <tr><td><b>d</b></td><td>Deontic</td></tr>
                <tr><td><b>i</b></td><td>Aim</td></tr>
                <tr><td><b>b</b></td><td>Direct Object</td></tr>
                <tr><td><b>Shift-b</b></td><td>Direct Object Property</td></tr>
                <tr><td><b>n</b></td><td>Indirect Object</td></tr>
                <tr><td><b>Shift-n</b></td><td>Indirect Object Property</td></tr>
                <tr><td><b>c</b></td><td>Activation Condition</td></tr>
                <tr><td><b>v</b></td><td>Execution Constraint</td></tr>
                <tr><td><b>e</b></td><td>Constituted Entity</td></tr>
                <tr><td><b>shift-e</b></td><td>Constituted Entity Property</td></tr>
                <tr><td><b>m</b></td><td>Modal</td></tr>
                <tr><td><b>f</b></td><td>Constitutive Function</td></tr>
                <tr><td><b>p</b></td><td>Constituting Properties</td></tr>
                <tr><td><b>Shift-p</b></td><td>Constituting Properties Properties</td></tr>
                <tr><td><b>o</b></td><td>Or Else</td></tr>
                <tr><td><b>l</b></td><td>Logical Operator*</td></tr>
            </table>
            * If the selection is not a logical operator, the text will nevertheless be capitalized and held in square brackets.<br>
            Other keybindings include standard copying and pasting in the editor and undo ('q') and redo ('w'). <br>
            <div class="button" role="button" aria-pressed="false" tabindex="0" id="keybindModalClose" style="float:right" autofocus onclick="closeModal('keybindModal')">Close</div>
        </dialog>

        <!-- Hidden textarea that holds encoded statement; this is used for form submission -->
        <textarea id="codedStmt" name="codedStmt" onfocusin="check(this)" onkeyup="check(this)" style="display:none;">{{.CodedStmt}}</textarea><br />
        <!-- Link to reset form content to default values -->
        <span data-text="Resets the 'Original Statement' and 'Encoded Statement' fields to the original example content. Note that this will overwrite the current content (e.g., statements you coded)." class="tooltip"><a id="example1" href="#" onclick="resetContent()">Reset to default statement example</a></span>
        &nbsp;&nbsp;&nbsp;<span data-text="Switches to a moderately complex example statement showcasing advanced component-level nesting, component combinations and semantic annotations. Note that this will overwrite the current content (e.g., statements you coded)." class="tooltip"><a id="example2" href="#" onclick="linkIntercept(event)">Example Statement 2 (moderately complex)</a></span>
        &nbsp;&nbsp;&nbsp;<span data-text="Switches to a complex example statement showcasing combinations of nested activation conditions in addition to the features showcased in the second example. Note that this will overwrite the current content (e.g., statements you coded)." class="tooltip"><a id="example3" href="#" onclick="linkIntercept(event)">Example Statement 3 (complex)</a></span><br /><br />
